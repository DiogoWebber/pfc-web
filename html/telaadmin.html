<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <div class="container">
        <h2>Admin</h2>
        <div class="buttons">
            <button onclick="window.location.href='/lembrete.html'">Lembrete</button>
            <button onclick="window.location.href='/cadastro-contas.html'">Cadastro de Contas Bancarias</button>
            <button onclick="openModal()">Cadastro de Usuários</button>
        </div>
    </div>
    <div class="container">
        <h2>Controle de Finanças</h2>
        <div class="summary-section">
            <div class="summary-box">
                <h3>Entrada</h3>
                <p>R$ <span id="entryTotal">0.00</span></p>
            </div>
            <div class="summary-box">
                <h3>Saída</h3>
                <p>R$ <span id="exitTotal">0.00</span></p>
            </div>
            <div class="summary-box">
                <h3>Total</h3>
                <p>R$ <span id="total">0.00</span></p>
            </div>
        </div>
        <div class="entry-section">
            <h3>Nova Transação</h3>
            <div class="entry-form">
                <input type="text" id="description" placeholder="Descrição" required>
                <input type="text" id="value" placeholder="Valor" required>
                <input type="text" id="date" placeholder="Data (DD/MM/YYYY)" required>
                <select id="type">
                    <option value="entry">Entrada</option>
                    <option value="exit">Saída</option>
                </select>
                <button onclick="submitTransaction()">Incluir</button>
            </div>
        </div>

        <!-- Modal -->
        <div id="userModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Lista de Usuários</h2>
                <ul id="userList">
                    <!-- Aqui serão listados os usuários -->
                </ul>
            </div>
        </div>
        <!-- Fim do Modal -->

        <table class="transaction-table">
            <thead>
                <tr>
                    <th>Descrição</th>
                    <th>Valor</th>
                    <th>Tipo</th>
                    <th>Data</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="transactionBody">
                <!-- Aqui serão adicionadas as transações -->
            </tbody>
        </table>
    </div>
    <script>
        // Função para enviar a nova transação para o servidor
        function submitTransaction() {
            const description = document.getElementById('description').value;
            const value = parseFloat(document.getElementById('value').value);
            const type = document.getElementById('type').value;
            const date = document.getElementById('date').value;

            // Validar se a data está no formato correto (DD/MM/YYYY)
            if (!isValidDateFormat(date)) {
                alert('Por favor, insira uma data no formato DD/MM/YYYY.');
                return;
            }

            if (!description || isNaN(value) || !type) {
                alert('Por favor, preencha todos os campos corretamente.');
                return;
            }

            const transaction = { description, value, type, date: formatDate(date) };
            fetch('/api/transactions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(transaction)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Erro ao adicionar transação');
                })
                .then(data => {
                    if (data.success) {
                        // Se a transação for adicionada com sucesso, atualizar a tabela de transações e os totais
                        updateTransactionTable();
                        updateTotals();
                    } else {
                        // Se houver algum erro, exibir uma mensagem de erro
                        alert('Erro ao adicionar transação. Por favor, tente novamente.');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao adicionar transação. Por favor, tente novamente.');
                });
        }

        // Função para validar o formato da data (DD/MM/YYYY)
        function isValidDateFormat(dateString) {
            const pattern = /^\d{2}\/\d{2}\/\d{4}$/;
            return pattern.test(dateString);
        }

        function deleteTransactionHandler(transactionId) {
            fetch(`/api/transactions/${transactionId}`, {
                method: 'DELETE',
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Erro ao excluir transação');
                })
                .then(data => {
                    if (data.success) {
                        // Se a transação for excluída com sucesso, atualize a tabela de transações e os totais
                        updateTransactionTable();
                        updateTotals();
                    } else {
                        // Se houver algum erro, exiba uma mensagem de erro
                        alert('Erro ao excluir transação. Por favor, tente novamente.');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao excluir transação. Por favor, tente novamente.');
                });
        }

        function updateTransactionHandler(transactionId, description, value, type, date) {
            const updatedTransaction = { description, value, type, date };

            fetch(`/api/transactions/${transactionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedTransaction)
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Erro ao editar transação: ' + response.statusText);
                })
                .then(data => {
                    if (data.success) {
                        updateTransactionTable();
                        updateTotals();
                    } else {
                        alert('Erro ao editar transação. Por favor, tente novamente.');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao editar transação. Por favor, tente novamente.');
                });
        }


        function updateTransactionTable() {
            fetch('/api/transactions')
                .then(response => response.json())
                .then(transactions => {
                    const tableBody = document.getElementById('transactionBody');
                    tableBody.innerHTML = '';

                    transactions.forEach(transaction => {
                        const newRow = document.createElement('tr');

                        const descriptionCell = document.createElement('td');
                        descriptionCell.textContent = transaction.description;

                        const valueCell = document.createElement('td');
                        // Verifica se o valor é um número antes de formatá-lo
                        valueCell.textContent = typeof transaction.value === 'number' ? transaction.value.toFixed(2) : '';

                        const dateCell = document.createElement('td');
                        dateCell.textContent = formatDate(transaction.date); // Formatando a data

                        const typeCell = document.createElement('td');
                        typeCell.textContent = transaction.type === 'entry' ? 'Entrada' : 'Saída';

                        const editCell = document.createElement('td');

                        const editButton = document.createElement('button');
                        editButton.textContent = 'Editar';
                        editButton.addEventListener('click', () => {
                            // Torna os campos editáveis
                            descriptionCell.contentEditable = true;
                            valueCell.contentEditable = true;
                            dateCell.contentEditable = true;
                            typeCell.contentEditable = true;

                            // Substitui o botão "Editar" por um botão "Salvar"
                            editButton.style.display = 'none';
                            saveButton.style.display = 'inline-block';
                        });

                        const saveButton = document.createElement('button');
                        saveButton.textContent = 'Salvar';
                        saveButton.style.display = 'none';
                        saveButton.addEventListener('click', () => {
                            // Envie uma solicitação para atualizar a transação
                            updateTransactionHandler(transaction.id, descriptionCell.textContent, parseFloat(valueCell.textContent), typeCell.textContent === 'Entrada' ? 'entry' : 'exit', formatDate(dateCell.textContent));

                            // Torna os campos não editáveis novamente
                            descriptionCell.contentEditable = false;
                            valueCell.contentEditable = false;
                            dateCell.contentEditable = false;
                            typeCell.contentEditable = false;

                            // Substitui o botão "Salvar" por um botão "Editar"
                            saveButton.style.display = 'none';
                            editButton.style.display = 'inline-block';
                        });

                        const deleteCell = document.createElement('td');
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Excluir';
                        deleteButton.addEventListener('click', () => deleteTransactionHandler(transaction.id));
                        deleteCell.appendChild(deleteButton);

                        newRow.appendChild(descriptionCell);
                        newRow.appendChild(valueCell);
                        newRow.appendChild(typeCell);
                        newRow.appendChild(dateCell);
                        newRow.appendChild(editCell);
                        newRow.appendChild(deleteCell);

                        editCell.appendChild(editButton);
                        editCell.appendChild(saveButton);

                        tableBody.appendChild(newRow);
                    });
                })
                .catch(error => console.error('Erro:', error));
        }

        function openModal() {
        const modal = document.getElementById('userModal');
        modal.style.display = 'block';
        fetchUsers(); // Chamar a função para buscar os usuários quando o modal é aberto
    }

    function closeModal() {
        const modal = document.getElementById('userModal');
        modal.style.display = 'none';
    }

    function fetchUsers() {
    fetch('/user/users')
        .then(response => response.json())
        .then(users => {
            const userList = document.getElementById('userList');
            userList.innerHTML = ''; // Limpar a lista antes de adicionar os usuários

            // Adicionar cada usuário à lista
            users.forEach(user => {
                const listItem = document.createElement('li');

                // Nome de usuário
                const usernameLabel = document.createElement('span');
                usernameLabel.textContent = `Username: ${user.username}`;
                listItem.appendChild(usernameLabel);

                // Nível do usuário
                const levelLabel = document.createElement('span');
                levelLabel.textContent = `Nível: ${user.level}`;
                listItem.appendChild(levelLabel);

                // Campo de seleção para o novo nível (ON/OFF)
                const newLevelSelect = document.createElement('select');
                const onOption = document.createElement('option');
                onOption.value = 'ON';
                onOption.textContent = 'ON';
                const offOption = document.createElement('option');
                offOption.value = 'OFF';
                offOption.textContent = 'OFF';
                newLevelSelect.appendChild(onOption);
                newLevelSelect.appendChild(offOption);
                newLevelSelect.value = user.level;
                listItem.appendChild(newLevelSelect);

                // Botão para alterar o nível
                const changeLevelButton = document.createElement('button');
                changeLevelButton.textContent = 'Alterar Nível';
                changeLevelButton.addEventListener('click', () => {
                    updateUserLevel(user.id, newLevelSelect.value);
                });
                listItem.appendChild(changeLevelButton);

                userList.appendChild(listItem);
            });
        })
        .catch(error => console.error('Erro:', error));
}


    function updateUserLevel(userId, newLevel) {
        // Envie uma solicitação para atualizar o nível do usuário
        fetch(`/user/update-level/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ level: newLevel })
        })
            .then(response => {
                if (response.ok) {
                    // Se a atualização for bem-sucedida, recarregue a lista de usuários
                    fetchUsers();
                } else {
                    throw new Error('Erro ao atualizar nível do usuário');
                }
            })
            .catch(error => console.error('Erro:', error));
    }


        // Função para formatar a data para o formato "YYYY-MM-DD"
        function formatDate(dateString) {
            // Verificar se a data está no formato correto (DD/MM/YYYY)
            const datePattern = /^(\d{2})\/(\d{2})\/(\d{4})$/;
            if (!datePattern.test(dateString)) {
                // Se a data não estiver no formato correto, retornar a data original
                return dateString;
            }

            // Se a data estiver no formato correto, realizar a formatação
            const [day, month, year] = dateString.split('/');
            return `${year}-${month}-${day}`;
        }


        // Função para atualizar os totais de entrada, saída e saldo final
        function updateTotals() {
            fetch('/api/transactions')
                .then(response => response.json())
                .then(transactions => {
                    let entryTotal = 0;
                    let exitTotal = 0;

                    transactions.forEach(transaction => {
                        if (transaction.type === 'entry') {
                            entryTotal += transaction.value;
                        } else if (transaction.type === 'exit') {
                            exitTotal += transaction.value;
                        }
                    });

                    const totalEntryElement = document.getElementById('entryTotal');
                    totalEntryElement.textContent = entryTotal.toFixed(2);

                    const totalExitElement = document.getElementById('exitTotal');
                    totalExitElement.textContent = exitTotal.toFixed(2);

                    const totalElement = document.getElementById('total');
                    const total = entryTotal - exitTotal;
                    totalElement.textContent = total.toFixed(2);
                })
                .catch(error => console.error('Erro:', error));
        }

        // Carregar as transações e os totais ao carregar a página
        updateTransactionTable();
        updateTotals();
    </script>

</body>

</html>